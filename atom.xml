<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Coveyzy</title>
  
  
  <link href="http://coveyzy.vip/atom.xml" rel="self"/>
  
  <link href="http://coveyzy.vip/"/>
  <updated>2021-08-29T01:46:34.444Z</updated>
  <id>http://coveyzy.vip/</id>
  
  <author>
    <name>Coveyzy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>通过RMAN方式搭建Oracle 10G DataGuard</title>
    <link href="http://coveyzy.vip/2021/08/23/2021-08-23-%E9%80%9A%E8%BF%87RMAN%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAOracle-10G-DataGuard/"/>
    <id>http://coveyzy.vip/2021/08/23/2021-08-23-%E9%80%9A%E8%BF%87RMAN%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAOracle-10G-DataGuard/</id>
    <published>2021-08-23T06:46:38.000Z</published>
    <updated>2021-08-29T01:46:34.444Z</updated>
    
    <content type="html"><![CDATA[<h1 id="通过RMAN方式搭建Oracle-10G-DataGuard"><a href="#通过RMAN方式搭建Oracle-10G-DataGuard" class="headerlink" title="通过RMAN方式搭建Oracle 10G DataGuard"></a>通过RMAN方式搭建Oracle 10G DataGuard</h1><blockquote><p>如有错误之处，恳请指正。</p></blockquote><h3 id="步骤总结"><a href="#步骤总结" class="headerlink" title="步骤总结"></a>步骤总结</h3><ol><li>standby系统配置</li><li>打包软件并拷贝</li><li>解压后的操作</li><li>主库参数修改及备份</li><li>备库参数修改及还原</li><li>开启日志应用</li><li>问题处理</li></ol><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><p><strong>primary</strong>：</p><p>​        version：Oracle 10g 10.2.0.3</p><p>​        instance_name：member</p><p>​        db_unique_name：MEMSTD2</p><p>​        OS：CentOS 5.6</p><p><strong>standby:</strong></p><p>​        version：Oracle 10g 10.2.0.3</p><p>​        instance_name：memberdg</p><p>​        db_unique_name：MEMBERDG</p><p>​        OS：CentOS 5.6</p><h3 id="standby配置"><a href="#standby配置" class="headerlink" title="standby配置"></a>standby配置</h3><ol><li><strong>操作系统参数调整</strong></li></ol><p>略。正常配置即可。</p><ol start="2"><li><strong>添加用户和组</strong></li></ol><p><code>groupadd oinstall</code></p><p><code>groupadd dba</code></p><p><code>useradd -g oinstall -G dba oracle</code></p><p><code>passwd oracle</code></p><ol start="3"><li><strong>修改.bash_profile</strong></li></ol><p>从primary拷贝过来</p><p><code>scp ~/.bash_profile standby:$PWD</code></p><p>也可手动修改</p><h3 id="打包软件并拷贝"><a href="#打包软件并拷贝" class="headerlink" title="打包软件并拷贝"></a>打包软件并拷贝</h3><ol><li><strong>打包软件</strong></li></ol><p><code>tar -zcpf oracle.tar.gz /oracle</code></p><ol start="2"><li><strong>传输文件</strong></li></ol><p><code>scp oracle.tar.gz standby:/data/software</code></p><ol start="3"><li><strong>解压软件</strong></li></ol><p><code>tar -zxf oracle.tar.gz -C /oracle</code></p><ol start="4"><li><strong>权限管理</strong></li></ol><p>打包文件本身包含了权限，如果有问题也可以手动修改</p><p><code>chown -R oracle:oinstall /oracle</code></p><ol start="5"><li><strong>执行脚本</strong></li></ol><p><strong>oralce</strong>用户下执行：</p><p><code>relink all</code></p><p><code>sh $ORACLE_HOME/install/changePerm.sh</code></p><p><strong>root</strong>用户下执行：</p><p><code>sh $ORACLE_HOME/root.sh</code></p><h3 id="主库参数修改及备份"><a href="#主库参数修改及备份" class="headerlink" title="主库参数修改及备份"></a>主库参数修改及备份</h3><p>下列操作如未特别说明，默认在主库操作</p><ol><li><strong>开启强制日志记录</strong></li></ol><p>保证DataGuard的可恢复性，强制数据库在任何状态下都必须记录日志</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> force_logging <span class="keyword">from</span> v$database;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回值为NO，则执行该语句开启</span></span><br><span class="line"><span class="keyword">alter</span> database force logging;</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>修改参数文件</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> LOG_ARCHIVE_CONFIG<span class="operator">=</span><span class="string">&#x27;DG_CONFIG=(MEMSTD2,MEMBERDG)&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> LOG_ARCHIVE_DEST_2<span class="operator">=</span><span class="string">&#x27;SERVICE=MEMBERDG LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLES) DB_UNIQUE_NAME=MEMBERDG&#x27;</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> LOG_ARCHIVE_DEST_STATE_1<span class="operator">=</span>ENABLE;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> LOG_ARCHIVE_DEST_STATE_2<span class="operator">=</span>ENABLE;</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>修改tnsnames.ora配置</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加以下内容</span></span><br><span class="line"><span class="keyword">MEMBER</span> <span class="operator">=</span></span><br><span class="line">  (DESCRIPTION <span class="operator">=</span></span><br><span class="line">    (ADDRESS <span class="operator">=</span> (PROTOCOL <span class="operator">=</span> TCP)(HOST <span class="operator">=</span> <span class="keyword">primary</span>)(PORT <span class="operator">=</span> <span class="number">1521</span>))</span><br><span class="line">    (CONNECT_DATA <span class="operator">=</span></span><br><span class="line">      (SERVER <span class="operator">=</span> DEDICATED)</span><br><span class="line">      (SERVICE_NAME <span class="operator">=</span> member1)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">MEMBERDG <span class="operator">=</span></span><br><span class="line">  (DESCRIPTION <span class="operator">=</span></span><br><span class="line">    (ADDRESS_LIST <span class="operator">=</span></span><br><span class="line">      (ADDRESS <span class="operator">=</span> (PROTOCOL <span class="operator">=</span> TCP)(HOST <span class="operator">=</span> standby)(PORT <span class="operator">=</span> <span class="number">1521</span>))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA <span class="operator">=</span></span><br><span class="line">      (SERVER <span class="operator">=</span> DEDICATED)</span><br><span class="line">      (SERVICE_NAME <span class="operator">=</span> memberdg)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>创建standby redo log</strong></li></ol><p>建议比online redo log多一组，size相同</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">21</span> (<span class="string">&#x27;/data/memberdg/std_log_2101.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">22</span> (<span class="string">&#x27;/data/memberdg/std_log_2201.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">23</span> (<span class="string">&#x27;/data/memberdg/std_log_2301.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">24</span> (<span class="string">&#x27;/data/memberdg/std_log_2401.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">25</span> (<span class="string">&#x27;/data/memberdg/std_log_2501.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">26</span> (<span class="string">&#x27;/data/memberdg/std_log_2601.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">27</span> (<span class="string">&#x27;/data/memberdg/std_log_2701.log&#x27;</span>) size <span class="number">500</span>m;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>使用rman备份主库</strong></li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rman target <span class="operator">/</span></span><br><span class="line"></span><br><span class="line">run&#123;</span><br><span class="line"><span class="keyword">allocate</span> channel ch1 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch2 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch3 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch4 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch5 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch6 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch7 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch8 device type disk;</span><br><span class="line">backup DATABASE include <span class="keyword">CURRENT</span> controlfile format <span class="string">&#x27;/data1/backup/member_%d_%T_%s_%p&#x27;</span>;</span><br><span class="line"><span class="keyword">release</span> channel ch1;</span><br><span class="line"><span class="keyword">release</span> channel ch2;</span><br><span class="line"><span class="keyword">release</span> channel ch3;</span><br><span class="line"><span class="keyword">release</span> channel ch4;</span><br><span class="line"><span class="keyword">release</span> channel ch5;</span><br><span class="line"><span class="keyword">release</span> channel ch6;</span><br><span class="line"><span class="keyword">release</span> channel ch7;</span><br><span class="line"><span class="keyword">release</span> channel ch8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li><strong>拷贝备份文件至standby</strong></li></ol><p><code>scp /data1/backup/* standby:$PWD</code></p><h3 id="备库参数修改及还原"><a href="#备库参数修改及还原" class="headerlink" title="备库参数修改及还原"></a>备库参数修改及还原</h3><p>下列操作如未特别说明，默认在主库操作</p><ol><li><strong>参数文件配置</strong></li></ol><p>在<strong>primary</strong>生成pfile参数文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> pfile <span class="operator">=</span> <span class="string">&#x27;/data1/backup/pfile.ora&#x27;</span> <span class="keyword">from</span> spfile;</span><br></pre></td></tr></table></figure><p>拷贝至standby</p><p><code>scp /data1/backup/pfile.ora standby:/data/backup/</code></p><p><strong>standby</strong>生成spfile文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> spfile <span class="keyword">from</span> pfile <span class="operator">=</span> <span class="string">&#x27;/data/backup/pfile.ora&#x27;</span>;</span><br></pre></td></tr></table></figure><p>手动创建参数文件中指定的audit_file_dest、background_dump_dest、core_dump_dest、db_recovery_file_dest、user_dump_dest等目录</p><p>启动实例至nomount</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup nomount</span><br></pre></td></tr></table></figure><p>修改备库参数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> db_unique_name <span class="operator">=</span> memberdg <span class="keyword">scope</span><span class="operator">=</span>spfile;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> log_archive_config<span class="operator">=</span><span class="string">&#x27;DG_CONFIG=(MEMSTD2,MEMBERDG)&#x27;</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> LOG_ARCHIVE_DEST_2<span class="operator">=</span><span class="string">&#x27;SERVICE=MEMSTD2 LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=MEMSTD2&#x27;</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> LOG_ARCHIVE_DEST_STATE_1<span class="operator">=</span>ENABLE;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> LOG_ARCHIVE_DEST_STATE_2<span class="operator">=</span>DEFER;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> remote_login_passwordfile<span class="operator">=</span><span class="string">&#x27;EXCLUSIVE&#x27;</span> <span class="keyword">scope</span><span class="operator">=</span>spfile;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> DB_FILE_NAME_CONVERT<span class="operator">=</span><span class="string">&#x27;/data/member/&#x27;</span>,<span class="string">&#x27;/data/memberdg/&#x27;</span>,<span class="string">&#x27;/data1/member/&#x27;</span>,<span class="string">&#x27;/data/memberdg/&#x27;</span> <span class="keyword">scope</span><span class="operator">=</span>spfile;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> LOG_FILE_NAME_CONVERT<span class="operator">=</span><span class="string">&#x27;/data/member/&#x27;</span>,<span class="string">&#x27;/data/memberdg/&#x27;</span>,<span class="string">&#x27;/data1/member/&#x27;</span>,<span class="string">&#x27;/data/memberdg/&#x27;</span> <span class="keyword">scope</span><span class="operator">=</span>spfile;</span><br></pre></td></tr></table></figure><p><code>shutdown</code></p><ol start="2"><li><strong>配置控制文件</strong></li></ol><p><strong>primary</strong>执行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> database <span class="keyword">create</span> standby controlfile <span class="keyword">as</span> <span class="string">&#x27;/data1/backup/ctl.bak&#x27;</span>;</span><br></pre></td></tr></table></figure><p><code>scp /data1/backup/ctl.bak standby:/data/backup/</code></p><p>备库将该文件拷贝至对应目录并改名</p><p>将备库起到mount状态</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup mount</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>使用rman进行还原</strong></li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">rman target <span class="operator">/</span></span><br><span class="line"></span><br><span class="line">catalog <span class="keyword">start</span> <span class="keyword">with</span> <span class="string">&#x27;/data/backup/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">run&#123;</span><br><span class="line"><span class="keyword">allocate</span> channel ch1 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch2 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch3 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch4 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch5 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch6 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch7 device type disk;</span><br><span class="line"><span class="keyword">allocate</span> channel ch8 device type disk;</span><br><span class="line">restore database;</span><br><span class="line"><span class="keyword">release</span> channel ch1;</span><br><span class="line"><span class="keyword">release</span> channel ch2;</span><br><span class="line"><span class="keyword">release</span> channel ch3;</span><br><span class="line"><span class="keyword">release</span> channel ch4;</span><br><span class="line"><span class="keyword">release</span> channel ch5;</span><br><span class="line"><span class="keyword">release</span> channel ch6;</span><br><span class="line"><span class="keyword">release</span> channel ch7;</span><br><span class="line"><span class="keyword">release</span> channel ch8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>创建standby redo log</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">21</span> (<span class="string">&#x27;/data/memberdg/std_log_2101.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">22</span> (<span class="string">&#x27;/data/memberdg/std_log_2201.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">23</span> (<span class="string">&#x27;/data/memberdg/std_log_2301.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">24</span> (<span class="string">&#x27;/data/memberdg/std_log_2401.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">25</span> (<span class="string">&#x27;/data/memberdg/std_log_2501.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">26</span> (<span class="string">&#x27;/data/memberdg/std_log_2601.log&#x27;</span>) size <span class="number">500</span>m;</span><br><span class="line"><span class="keyword">alter</span> database <span class="keyword">add</span> standby logfile <span class="keyword">group</span> <span class="number">27</span> (<span class="string">&#x27;/data/memberdg/std_log_2701.log&#x27;</span>) size <span class="number">500</span>m;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>修改tnsnames.ora</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MEMBER</span> <span class="operator">=</span></span><br><span class="line">  (DESCRIPTION <span class="operator">=</span></span><br><span class="line">    (ADDRESS <span class="operator">=</span> (PROTOCOL <span class="operator">=</span> TCP)(HOST <span class="operator">=</span> <span class="keyword">primary</span>)(PORT <span class="operator">=</span> <span class="number">1521</span>))</span><br><span class="line">    (CONNECT_DATA <span class="operator">=</span></span><br><span class="line">      (SERVER <span class="operator">=</span> DEDICATED)</span><br><span class="line">      (SERVICE_NAME <span class="operator">=</span> member1)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">MEMBERDG <span class="operator">=</span></span><br><span class="line">  (DESCRIPTION <span class="operator">=</span></span><br><span class="line">    (ADDRESS_LIST <span class="operator">=</span></span><br><span class="line">      (ADDRESS <span class="operator">=</span> (PROTOCOL <span class="operator">=</span> TCP)(HOST <span class="operator">=</span> standby)(PORT <span class="operator">=</span> <span class="number">1521</span>))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA <span class="operator">=</span></span><br><span class="line">      (SERVER <span class="operator">=</span> DEDICATED)</span><br><span class="line">      (SERVICE_NAME <span class="operator">=</span> memberdg)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><ol start="6"><li><strong>开启force logging</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> force_logging <span class="keyword">from</span> v$database;</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> database force logging;</span><br></pre></td></tr></table></figure><ol start="7"><li><strong>添加静态监听</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SID_LIST_LISTENER <span class="operator">=</span></span><br><span class="line"> (SID_LIST <span class="operator">=</span></span><br><span class="line">      (SID_DESC <span class="operator">=</span></span><br><span class="line">        (GLOBAL_DBNAME <span class="operator">=</span> MEMBERDG)</span><br><span class="line">        (ORACLE_HOME <span class="operator">=</span> <span class="operator">/</span>oracle<span class="operator">/</span>app<span class="operator">/</span>product<span class="operator">/</span><span class="number">10.0</span><span class="number">.2</span><span class="operator">/</span>db_1)</span><br><span class="line">        (SID_NAME <span class="operator">=</span> memberdg)</span><br><span class="line">      )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="开启日志应用"><a href="#开启日志应用" class="headerlink" title="开启日志应用"></a>开启日志应用</h3><ol><li><strong>tnsping检查主备通信</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tnsping <span class="keyword">primary</span></span><br><span class="line">tnsping standby</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>备库开启日志应用</strong></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> database recover managed standby database <span class="keyword">using</span> <span class="keyword">current</span> logfile <span class="keyword">disconnect</span> <span class="keyword">from</span> session ;</span><br></pre></td></tr></table></figure><ol start="3"><li>检查应用情况</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 检查alert日志</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查进程</span></span><br><span class="line"><span class="keyword">select</span> process,status,sequence#,block# <span class="keyword">from</span> gv$managed_standby;</span><br></pre></td></tr></table></figure><h3 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h3><ol><li><strong>alert日志报错如下：</strong></li></ol><p><img src="https://gitee.com/coveyzy/imgs/raw/master/img/202108231422599.png" alt="image-20210823142243851"></p><p><strong>解决办法：</strong></p><p>如果设置有<code>fal_client</code>和<code>fal_server</code>参数，DG会自动寻找缺失的日志，前提是日志文件没被覆盖或归档文件还在。</p><p>这里因为归档已经不在了，只能通过基于SCN的增量备份后进行恢复，具体步骤如下：</p><p>（1）<strong>确定SCN</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行以下语句，哪个值小就从哪个开始增备</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(first_nonlogged_scn) <span class="keyword">from</span> v$datafile <span class="keyword">where</span> first_nonlogged_scn <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 可能不会有返回值，则以下面的返回值为开始SCN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> current_scn <span class="keyword">from</span> v$database;</span><br></pre></td></tr></table></figure><p>（2）<strong>主库执行增量备份</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backup incremental <span class="keyword">from</span> scn <span class="number">48310199829</span> database format <span class="string">&#x27;/data1/backup/archivedlog_%U&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 备份控制文件</span></span><br><span class="line">backup <span class="keyword">current</span> controlfile <span class="keyword">for</span> standby format <span class="string">&#x27;/data1/backup/controlfile.bak&#x27;</span>;</span><br></pre></td></tr></table></figure><p>（3）<strong>备库恢复数据库</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recover database noredo;</span><br><span class="line"></span><br><span class="line">restore standby controlfile <span class="keyword">from</span> <span class="string">&#x27;/data/backup/controlfile.bak&#x27;</span>;</span><br></pre></td></tr></table></figure><p>（4）<strong>备库重新开启日志应用</strong></p><ol start="2"><li><strong>备库需要手动创建standby redo log</strong></li></ol><p><img src="https://gitee.com/coveyzy/imgs/raw/master/img/202108231437761.png" alt="image-20210823143745687"></p><p>还有一些小问题，没有及时记录，就不bb了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;通过RMAN方式搭建Oracle-10G-DataGuard&quot;&gt;&lt;a href=&quot;#通过RMAN方式搭建Oracle-10G-DataGuard&quot; class=&quot;headerlink&quot; title=&quot;通过RMAN方式搭建Oracle 10G DataGuard&quot;&gt;</summary>
      
    
    
    
    <category term="DataGuard" scheme="http://coveyzy.vip/categories/DataGuard/"/>
    
    
    <category term="Oracle DataGuard" scheme="http://coveyzy.vip/tags/Oracle-DataGuard/"/>
    
  </entry>
  
  <entry>
    <title>使用permission.pl脚本修复节点文件权限</title>
    <link href="http://coveyzy.vip/2021/07/07/2021-07-07-%E4%BD%BF%E7%94%A8permission-pl%E8%84%9A%E6%9C%AC%E4%BF%AE%E5%A4%8D%E8%8A%82%E7%82%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/"/>
    <id>http://coveyzy.vip/2021/07/07/2021-07-07-%E4%BD%BF%E7%94%A8permission-pl%E8%84%9A%E6%9C%AC%E4%BF%AE%E5%A4%8D%E8%8A%82%E7%82%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/</id>
    <published>2021-07-07T02:58:22.000Z</published>
    <updated>2021-07-07T03:01:16.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><code>Script to capture and restore file permission in a directory (for eg. ORACLE_HOME) (Doc ID 1515018.1)</code></p><p>问题描述：RAC两个节点中，在节点2执行了<code>chown -R oracle:oinstall /u01</code> 导致节点2 文件权限不对，集群状态异常</p><p>解决办法：通过官方提供的 <code>permission.pl</code> 脚本进行修复</p></blockquote><ol><li>校验节点2权限问题</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 校验失败，说明权限有异常</span><br><span class="line">[grid<span class="variable">@rac2</span> <span class="operator">~</span>]$ cluvfy comp software <span class="operator">-</span>n <span class="keyword">all</span> <span class="operator">-</span>verbose</span><br><span class="line"></span><br><span class="line">Verifying software</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span>: Software</span><br><span class="line"></span><br><span class="line"><span class="number">3162</span> files verified</span><br><span class="line"></span><br><span class="line">Software <span class="keyword">check</span> failed</span><br><span class="line"></span><br><span class="line">Verification <span class="keyword">of</span> software was failed.</span><br></pre></td></tr></table></figure><ol start="2"><li>1节点执行修复脚本</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 以root用户执行.<span class="operator">/</span>permission.pl <span class="operator">&lt;</span>Path name <span class="keyword">to</span> capture permission<span class="operator">&gt;</span></span><br><span class="line">[root<span class="variable">@rac1</span> u01]# .<span class="operator">/</span>permission.pl <span class="operator">/</span>u01<span class="operator">/</span></span><br><span class="line">.........</span><br><span class="line">Following log files <span class="keyword">are</span> generated</span><br><span class="line">logfile      : permission<span class="operator">-</span>Wed<span class="operator">-</span>Jul<span class="number">-07</span><span class="number">-10</span><span class="number">-21</span><span class="number">-13</span><span class="number">-2021</span></span><br><span class="line">Command file : restore<span class="operator">-</span>perm<span class="operator">-</span>Wed<span class="operator">-</span>Jul<span class="number">-07</span><span class="number">-10</span><span class="number">-21</span><span class="number">-13</span><span class="number">-2021.</span>cmd</span><br><span class="line">Linecount : <span class="number">62264</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@rac1</span> u01]# ls <span class="operator">-</span>lrt</span><br><span class="line">total <span class="number">17556</span></span><br><span class="line">drwxrwxr<span class="operator">-</span>x. <span class="number">7</span> grid oinstall     <span class="number">4096</span> Jan <span class="number">27</span> <span class="number">16</span>:<span class="number">14</span> soft</span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x  <span class="number">6</span> root oinstall       <span class="number">66</span> Jan <span class="number">28</span> <span class="number">12</span>:<span class="number">34</span> app</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x  <span class="number">1</span> root root         <span class="number">2451</span> Mar <span class="number">31</span> <span class="number">18</span>:<span class="number">08</span> permission.pl</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--  1 root root     11869417 Jul  7 10:22 restore-perm-Wed-Jul-07-10-21-13-2021.cmd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--  1 root root      6098198 Jul  7 10:22 permission-Wed-Jul-07-10-21-13-2021</span></span><br></pre></td></tr></table></figure><p>在当前目录下会生成两个文件:</p><p>a. <strong>permission-<time stamp></strong> - This contains file permission in octal value, owner and group information of the files captured<br>b. <strong>restore-perm-<time stamp>.cmd</strong> - This contains command to change the permission, owner, and group of the captured files</p><ol start="3"><li>将生成的两个文件拷贝到2节点</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rac1 u01]# scp permission-Wed-Jul-07-09-41-25-2021 root@rac2:&#x2F;u01</span><br><span class="line"></span><br><span class="line">[root@rac1 u01]# scp restore-perm-Wed-Jul-07-09-41-25-2021.cmd root@rac2:&#x2F;u01&#x2F;</span><br></pre></td></tr></table></figure><ol start="4"><li>修改<code>restore-perm-&lt;time stamp&gt;.cmd</code>中的信息</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 需要修改主机名、数据库实例名、ASM实例名</span><br><span class="line">[root<span class="variable">@rac2</span> u01]$ vi restore<span class="operator">-</span>perm<span class="operator">-</span>Wed<span class="operator">-</span>Jul<span class="number">-07</span><span class="number">-09</span><span class="number">-41</span><span class="number">-25</span><span class="number">-2021.</span>cmd</span><br><span class="line"></span><br><span class="line">:<span class="operator">%</span>s<span class="operator">/</span>rac1<span class="operator">/</span>rac2<span class="operator">/</span>g</span><br><span class="line">:<span class="operator">%</span>s<span class="operator">/</span>racdb1<span class="operator">/</span>racdb2<span class="operator">/</span>g</span><br><span class="line">:<span class="operator">%</span>s<span class="operator">/</span>ASM1<span class="operator">/</span>ASM2<span class="operator">/</span>g</span><br><span class="line">:<span class="operator">%</span>s<span class="operator">/</span>asm1<span class="operator">/</span>asm2<span class="operator">/</span>g</span><br><span class="line"></span><br><span class="line"># 赋予<span class="number">755</span>权限</span><br><span class="line">[root<span class="variable">@rac2</span> u01]# chmod <span class="number">755</span> restore<span class="operator">-</span>perm<span class="operator">-</span>Wed<span class="operator">-</span>Jul<span class="number">-07</span><span class="number">-09</span><span class="number">-41</span><span class="number">-25</span><span class="number">-2021.</span>cmd</span><br></pre></td></tr></table></figure><ol start="5"><li>以root用户执行<code>restore-perm-&lt;time stamp&gt;.cmd</code>文件</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@rac2</span> u01]# .<span class="operator">/</span>restore<span class="operator">-</span>perm<span class="operator">-</span>Wed<span class="operator">-</span>Jul<span class="number">-07</span><span class="number">-09</span><span class="number">-41</span><span class="number">-25</span><span class="number">-2021.</span>cmd</span><br></pre></td></tr></table></figure><p>屏幕输出中会有<code>chown</code>和<code>chmod</code>报错，主要原因为一些日志文件不存在引起</p><ol start="6"><li>重启主机或集群</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[grid<span class="variable">@rac2</span> <span class="operator">~</span>]$ crsctl stat res <span class="operator">-</span>t</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">NAME           TARGET  STATE        SERVER                   STATE_DETAILS</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">Local</span> Resources</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">ora.ARCH.dg</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line">ora.CRS.dg</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line">ora.LISTENER.lsnr</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line">ora.asm</span><br><span class="line">               ONLINE  ONLINE       rac1                     Started</span><br><span class="line">               ONLINE  ONLINE       rac2                     Started</span><br><span class="line">ora.gsd</span><br><span class="line">               OFFLINE OFFLINE      rac1</span><br><span class="line">               OFFLINE OFFLINE      rac2</span><br><span class="line">ora.net1.network</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line">ora.ons</span><br><span class="line">               ONLINE  ONLINE       rac1</span><br><span class="line">               ONLINE  ONLINE       rac2</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Cluster Resources</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">ora.LISTENER_SCAN1.lsnr</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1</span><br><span class="line">ora.cvu</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1</span><br><span class="line">ora.oc4j</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1</span><br><span class="line">ora.rac1.vip</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1</span><br><span class="line">ora.rac2.vip</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac2</span><br><span class="line">ora.racdb.db</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1                     <span class="keyword">Open</span></span><br><span class="line">      <span class="number">2</span>        ONLINE  ONLINE       rac2                     <span class="keyword">Open</span></span><br><span class="line">ora.scan1.vip</span><br><span class="line">      <span class="number">1</span>        ONLINE  ONLINE       rac1</span><br><span class="line">[grid<span class="variable">@rac2</span> <span class="operator">~</span>]$</span><br></pre></td></tr></table></figure><hr><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>权限修复成功的前提是必须有一个节点的权限是正常的，否则无法通过此方式进行修复</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Script to capture and restore file permission in a directory (for eg. ORACLE_HOME) (Doc ID 1515018.1)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;问题</summary>
      
    
    
    
    <category term="ORACLE" scheme="http://coveyzy.vip/categories/ORACLE/"/>
    
    
    <category term="RAC" scheme="http://coveyzy.vip/tags/RAC/"/>
    
    <category term="修复" scheme="http://coveyzy.vip/tags/%E4%BF%AE%E5%A4%8D/"/>
    
  </entry>
  
</feed>
